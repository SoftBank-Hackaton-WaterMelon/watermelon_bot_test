# Lambda 함수 개발 기술적 도전 과제

## **1) Slack 3초 타임아웃 문제 해결**

***고민***

Slack Slash Command는 3초 이내에 응답해야 하는데, GitHub API 호출 및 Lambda 처리 시간이 이를 초과할 수 있음. 타임아웃 발생 시 사용자에게 피드백을 제공할 수 없음.

***대안***

- **동기 처리 + 타임아웃 허용:** 가장 단순하지만 Slack 타임아웃 에러 발생 가능
- **SQS 큐 + 별도 Lambda:** 비동기 처리 가능하나 인프라 복잡도 증가
- **즉시 응답 + response_url 사용:** Slack의 response_url을 활용해 비동기로 결과 전송
- **Lambda 자기 재호출 (Invoke):** 현재 Lambda를 비동기로 재호출하여 GitHub API 호출 처리

***결정***

**즉시 응답 + Lambda 자기 재호출 방식**을 채택함

Slash Command 처리 시 즉시 "처리 중" 메시지를 반환하고, Lambda 함수를 비동기로 재호출하여 GitHub API 호출을 처리한 후 `response_url`을 통해 결과를 전송하는 구조로 구현

이를 통해 Slack 타임아웃을 회피하면서도 사용자에게 실시간 피드백을 제공할 수 있음

---

## **2) Slack 요청 서명 검증 구현**

***고민***

Slack에서 들어오는 요청이 실제로 Slack에서 온 것인지 보안상 검증이 필요함. 악의적인 요청으로부터 Lambda 함수를 보호해야 함.

***대안***

- **서명 검증 생략:** 개발 속도는 빠르지만 보안 취약점 존재
- **단순 토큰 비교:** 구현은 간단하나 재사용 공격(Replay Attack)에 취약
- **HMAC SHA256 기반 서명 검증:** Slack 공식 권장 방식으로 타임스탬프와 함께 검증

***결정***

**HMAC SHA256 기반 서명 검증**을 구현함

`x-slack-signature`와 `x-slack-request-timestamp` 헤더를 활용하여 `v0:{timestamp}:{body}` 형식의 서명을 생성하고 `hmac.compare_digest()`로 비교

추가로 타임스탬프 검증(5분 이내)을 통해 재사용 공격을 방지함

API Gateway를 통한 헤더 전달 시 대소문자가 변경될 수 있어 `get_header_value()` 헬퍼 함수를 구현하여 대소문자 구분 없이 헤더를 추출함

---

## **3) 비동기 Lambda 재호출 구조**

***고민***

Lambda 함수가 자기 자신을 비동기로 재호출할 때 IAM 권한 및 호출 방식에 대한 고려가 필요함.

***대안***

- **동기 처리로 폴백:** 비동기 호출 실패 시 동기 처리로 전환하되 타임아웃 위험 존재
- **SQS 큐 활용:** 완전한 비동기 처리 가능하나 추가 인프라 필요
- **Lambda Invoke (Event 타입):** 현재 함수를 비동기로 재호출, IAM 권한만 추가하면 됨

***결정***

**Lambda Invoke (Event 타입) + 동기 폴백** 방식을 채택함

`lambda:InvokeFunction` 권한을 IAM Role에 추가하고, `InvocationType='Event'`로 비동기 호출 시도

권한이 없거나 호출 실패 시 동기 처리로 폴백하여 안정성을 확보함

재호출된 Lambda는 `async_task` 필드를 확인하여 GitHub API 호출 등 실제 작업을 수행함

---

## **4) Interactive 버튼 승인 시스템**

***고민***

배포/롤백 전 승인 단계를 구현하려면 Slack Interactive Components를 활용해야 하는데, 상태 관리와 권한 검증이 복잡함.

***대안***

- **승인 단계 제거:** 가장 단순하지만 안전성 저하
- **외부 DB 상태 저장:** 승인 요청 상태를 DB에 저장하나 추가 인프라 필요
- **Base64 인코딩된 메타데이터:** 버튼 value에 승인 정보를 인코딩하여 전달

***결정***

**Base64 인코딩된 메타데이터 방식**을 채택함

승인 요청 시 `request_id`, `action_type`, `requested_by`, `command_text` 등을 Base64로 인코딩하여 버튼의 `value`에 저장

버튼 클릭 시 디코딩하여 승인자 ID 검증(`SLACK_APPROVER_IDS`) 후 실제 작업을 수행함

외부 저장소 없이도 승인 흐름을 구현할 수 있어 해커톤 환경에 적합함

---

## **5) 에러 처리 및 디버깅 전략**

***고민***

Lambda 함수에서 발생하는 다양한 에러(GitHub API 실패, 네트워크 오류, 인증 실패 등)를 어떻게 사용자에게 명확하게 전달하고, 개발자가 디버깅할 수 있을까?

***대안***

- **단순 에러 메시지:** 구현은 간단하지만 디버깅 정보 부족
- **상세 로깅만:** 개발자는 편하지만 사용자에게는 불필요한 정보 노출
- **구조화된 로깅 + 사용자 친화적 메시지:** CloudWatch에서 필터링 가능한 구조화 로그와 사용자용 간단한 메시지 분리

***결정***

**구조화된 로깅 + 사용자 친화적 메시지** 방식을 채택함

`log_event()` 함수를 구현하여 `event_type`, `timestamp`, `data` 구조로 CloudWatch에 로깅

사용자에게는 에러 유형별(401, 403, 404, 타임아웃 등)로 해결 방법을 포함한 친화적 메시지를 전송

GitHub API 호출 시 상세한 디버깅 정보(URL, 헤더, Payload, Response)를 로그에 기록하여 문제 추적이 용이하도록 함

---

## **6) API Gateway 헤더 처리**

***고민***

API Gateway를 통해 들어오는 Slack 요청의 헤더가 대소문자가 변경되거나 형식이 달라질 수 있음. `x-slack-signature` 헤더를 정확히 추출해야 함.

***대안***

- **정확한 헤더명 매칭:** 대소문자 변경 시 실패 가능
- **모든 헤더 순회 검색:** 성능 오버헤드는 있지만 안정적
- **대소문자 무시 헬퍼 함수:** 헤더명을 소문자로 변환하여 비교

***결정***

**대소문자 무시 헬퍼 함수(`get_header_value`)**를 구현함

헤더 딕셔너리를 순회하며 키를 소문자로 변환하여 비교하는 방식으로, API Gateway의 헤더 변환에 대응함

이를 통해 `X-Slack-Signature`, `x-slack-signature`, `X-SLACK-SIGNATURE` 등 어떤 형식으로 들어와도 정확히 추출 가능함

---

## **7) Slack 메시지 전송 방식 최적화**

***고민***

Slack 메시지를 전송하는 방법이 여러 가지 있는데(response_url, Bot Token API), 어떤 방식을 우선 사용하고 실패 시 어떻게 폴백할까?

***대안***

- **Bot Token만 사용:** 구현 단순하지만 response_url이 더 빠름
- **response_url만 사용:** Slash Command에만 사용 가능, 일반 메시지 전송 불가
- **response_url 우선 + Bot Token 폴백:** Slash Command 응답은 빠르게, 일반 메시지는 Bot Token 사용

***결정***

**response_url 우선 + Bot Token 폴백** 방식을 채택함

`send_slack_message()` 함수에서 `response_url`이 제공되면 우선 사용하고, 실패하거나 없을 경우 Bot Token API로 폴백

`response_url`은 3초 이내 응답이 가능하여 사용자 경험이 향상되며, Bot Token은 모든 상황에서 메시지 전송이 가능하여 안정성을 확보함

---

## **8) 환경변수 관리 및 기본값 처리**

***고민***

Lambda 환경변수가 설정되지 않았을 때 어떻게 처리하고, 선택적 기능(GIF 이미지, 승인 시스템 등)을 어떻게 활성화/비활성화할까?

***대안***

- **필수 환경변수만 사용:** 구현 단순하지만 유연성 부족
- **모든 환경변수 필수:** 설정 복잡도 증가
- **기본값 제공 + 선택적 기능:** 필수 변수는 필수로, 선택적 기능은 환경변수 존재 여부로 제어

***결정***

**기본값 제공 + 선택적 기능** 방식을 채택함

필수 환경변수(`GITHUB_TOKEN`, `SLACK_SIGNING_SECRET` 등)는 검증하고, 선택적 기능은 환경변수 존재 여부로 활성화

예를 들어 `GIF_BASE_URL`이 설정되면 자동으로 GIF 이미지를 표시하고, 없으면 텍스트만 표시

`DEPLOY_APPROVAL_REQUIRED`는 문자열을 파싱하여 boolean으로 변환하여 사용자가 쉽게 설정할 수 있도록 함
